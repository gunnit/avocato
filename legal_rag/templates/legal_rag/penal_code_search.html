{% extends "cases/base.html" %}

{% block content %}
<!--begin::Card-->
<div class="card">
    <!--begin::Card header-->
    <div class="card-header border-0 pt-6">
        <div class="card-title">
            <h2>Codice Penale</h2>
        </div>
        <div class="card-toolbar">
            <ul class="nav nav-tabs nav-line-tabs nav-stretch fs-6 border-0">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#kt_tab_table">Vista Tabella</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#kt_tab_search">Ricerca</a>
                </li>
            </ul>
        </div>
    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body py-4">
        <div class="tab-content" id="myTabContent">
            <!-- Begin Table View -->
            <div class="tab-pane fade show active" id="kt_tab_table" role="tabpanel">
                <div class="d-flex flex-column gap-5">
                    <!-- Table Filters -->
                    <div class="d-flex align-items-center gap-2">
                        <select class="form-select form-select-sm w-200px" id="bookFilter">
                            <option value="">Tutti i Libri</option>
                        </select>
                        <select class="form-select form-select-sm w-200px" id="titleFilter">
                            <option value="">Tutti i Titoli</option>
                        </select>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                            <thead>
                                <tr class="fw-bold text-muted">
                                    <th class="min-w-80px">Articolo</th>
                                    <th class="min-w-150px">Titolo</th>
                                    <th class="min-w-200px">Libro</th>
                                    <th class="min-w-100px text-end">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="articlesTableBody">
                                <!-- Table content will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex flex-wrap gap-2 py-2">
                            <select class="form-select form-select-sm w-100px" id="pageSizeSelect">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-muted pt-2">elementi per pagina</span>
                        </div>
                        <ul class="pagination" id="pagination">
                            <!-- Pagination will be populated dynamically -->
                        </ul>
                    </div>
                </div>
            </div>
            <!-- End Table View -->

            <!-- Begin Search View -->
            <div class="tab-pane fade" id="kt_tab_search" role="tabpanel">
                <!--begin::Search form-->
                <form id="penalCodeSearchForm" class="mb-8">
                    <div class="d-flex align-items-center position-relative my-1">
                        <span class="svg-icon svg-icon-1 position-absolute ms-4">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor"></rect>
                                <path d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z" fill="currentColor"></path>
                            </svg>
                        </span>
                        <input type="text" id="articleNumber" class="form-control form-control-solid w-250px ps-14" placeholder="Inserisci il numero dell'articolo">
                        <button type="submit" class="btn btn-primary ms-5">Cerca</button>
                    </div>
                </form>
                <!--end::Search form-->

                <!--begin::Results-->
                <div id="searchResults" class="d-none">
                    <div class="separator separator-dashed my-5"></div>
                    
                    <div id="resultsContent">
                        <!-- Results will be populated here -->
                    </div>

                    <div id="loadingSpinner" class="d-none">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>Ricerca in corso...</div>
                        </div>
                    </div>
                </div>
                <!--end::Results-->
            </div>
            <!-- End Search View -->
        </div>
    </div>
    <!--end::Card body-->
</div>
<!--end::Card-->

<!-- Article Detail Modal -->
<div class="modal fade" id="articleDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="articleDetailTitle">Dettaglio Articolo</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-column gap-5">
                    <div class="article-metadata">
                        <div class="d-flex flex-wrap gap-5">
                            <div class="d-flex flex-column gap-1">
                                <span class="text-muted fs-7">Libro</span>
                                <span class="fw-bold" id="articleDetailBook"></span>
                            </div>
                            <div class="d-flex flex-column gap-1">
                                <span class="text-muted fs-7">Titolo</span>
                                <span class="fw-bold" id="articleDetailTitleSection"></span>
                            </div>
                            <div class="d-flex flex-column gap-1">
                                <span class="text-muted fs-7">Sezione</span>
                                <span class="fw-bold" id="articleDetailSection"></span>
                            </div>
                        </div>
                    </div>
                    <div class="article-content">
                        <h4 class="mb-4" id="articleDetailHeading"></h4>
                        <div class="fs-6" id="articleDetailContent"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    let currentPage = 1;
    let pageSize = 10;
    let totalPages = 1;
    let articles = [];
    let books = [];
    let titles = [];

    // Initialize components
    const searchForm = document.getElementById('penalCodeSearchForm');
    const searchResults = document.getElementById('searchResults');
    const resultsContent = document.getElementById('resultsContent');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const bookFilter = document.getElementById('bookFilter');
    const titleFilter = document.getElementById('titleFilter');
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    const articlesTableBody = document.getElementById('articlesTableBody');
    const pagination = document.getElementById('pagination');

    // Load initial data
    loadBooks();
    loadArticles();

    // Event Listeners
    bookFilter.addEventListener('change', handleBookFilterChange);
    titleFilter.addEventListener('change', handleTitleFilterChange);
    pageSizeSelect.addEventListener('change', handlePageSizeChange);

    // Functions to handle data loading
    async function loadBooks() {
        try {
            const response = await fetch('/legal-rag/books/');
            books = await response.json();
            populateBookFilter();
        } catch (error) {
            console.error('Error loading books:', error);
        }
    }

    async function loadArticles(filters = {}) {
        try {
            const queryParams = new URLSearchParams({
                page: currentPage,
                page_size: pageSize,
                ...filters
            });
            
            const response = await fetch(`/legal-rag/articles/?${queryParams}`);
            const data = await response.json();
            
            articles = data.results;
            totalPages = Math.ceil(data.count / pageSize);
            
            renderArticlesTable();
            renderPagination();
        } catch (error) {
            console.error('Error loading articles:', error);
        }
    }

    // UI Rendering Functions
    function populateBookFilter() {
        bookFilter.innerHTML = '<option value="">Tutti i Libri</option>';
        books.forEach(book => {
            bookFilter.innerHTML += `<option value="${book.id}">Libro ${book.number} - ${book.name}</option>`;
        });
    }

    function renderArticlesTable() {
        articlesTableBody.innerHTML = '';
        articles.forEach(article => {
            articlesTableBody.innerHTML += `
                <tr>
                    <td>Art. ${article.number}</td>
                    <td>${article.heading}</td>
                    <td>${article.book_name}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-icon btn-light-primary" onclick="showArticleDetail(${article.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    function renderPagination() {
        pagination.innerHTML = '';
        
        // Previous button
        pagination.innerHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                pagination.innerHTML += `
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                `;
            }
        }

        // Next button
        pagination.innerHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    }

    // Event Handlers
    function handleBookFilterChange() {
        const bookId = bookFilter.value;
        currentPage = 1;
        loadArticles({ book_id: bookId });
        
        // Load titles for selected book
        if (bookId) {
            loadTitles(bookId);
        } else {
            titleFilter.innerHTML = '<option value="">Tutti i Titoli</option>';
            titleFilter.disabled = true;
        }
    }

    function handleTitleFilterChange() {
        const titleId = titleFilter.value;
        currentPage = 1;
        loadArticles({
            book_id: bookFilter.value,
            title_id: titleId
        });
    }

    function handlePageSizeChange() {
        pageSize = parseInt(pageSizeSelect.value);
        currentPage = 1;
        loadArticles();
    }

    // Article Detail Functions
    window.showArticleDetail = async function(articleId) {
        try {
            const response = await fetch(`/legal-rag/articles/${articleId}/`);
            const article = await response.json();
            
            document.getElementById('articleDetailTitle').textContent = `Articolo ${article.number}`;
            document.getElementById('articleDetailBook').textContent = article.book_name;
            document.getElementById('articleDetailTitleSection').textContent = article.title_name;
            document.getElementById('articleDetailSection').textContent = article.section_name || 'N/A';
            document.getElementById('articleDetailHeading').textContent = article.heading;
            document.getElementById('articleDetailContent').innerHTML = formatText(article.content);
            
            new bootstrap.Modal(document.getElementById('articleDetailModal')).show();
        } catch (error) {
            console.error('Error loading article details:', error);
        }
    }

    // Helper Functions
    function formatText(text) {
        return text.split('. ')
            .filter(sentence => sentence.trim() !== '')
            .map(sentence => `<p class="mb-2">${escapeHtml(sentence.trim())}${sentence.trim().endsWith('.') ? '' : '.'}</p>`)
            .join('');
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Search Form Handler
    searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const articleNumber = document.getElementById('articleNumber').value;
        if (!articleNumber) return;

        searchResults.classList.remove('d-none');
        loadingSpinner.classList.remove('d-none');
        resultsContent.innerHTML = '';

        try {
            const response = await fetch('/legal-rag/penal-code-search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ article_number: articleNumber })
            });

            const data = await response.json();
            loadingSpinner.classList.add('d-none');

            if (data.error) {
                resultsContent.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error)}</div>`;
                return;
            }

            if (data.results && data.results.length > 0) {
                resultsContent.innerHTML = data.results.map(result => `
                    <div class="border rounded p-5 mb-5">
                        <div class="mb-3">
                            <h3 class="text-dark fw-bold text-hover-primary mb-1 fs-5">
                                ${escapeHtml(result.title || 'Articolo del Codice Penale')}
                            </h3>
                        </div>
                        <div class="text-gray-600 fw-semibold fs-7 mb-4">
                            ${formatText(result.snippet)}
                        </div>
                        <div class="d-flex flex-stack">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-light" onclick="showArticleDetail(${result.id})">
                                    <i class="fas fa-eye me-2"></i>Visualizza Dettagli
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                resultsContent.innerHTML = '<div class="alert alert-info">Nessun risultato trovato.</div>';
            }
        } catch (error) {
            loadingSpinner.classList.add('d-none');
            resultsContent.innerHTML = '<div class="alert alert-danger">Si è verificato un errore durante la ricerca.</div>';
        }
    });

    // Expose pagination function to window
    window.changePage = function(newPage) {
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            loadArticles({
                book_id: bookFilter.value,
                title_id: titleFilter.value
            });
        }
    }
});
</script>
{% endblock %}
