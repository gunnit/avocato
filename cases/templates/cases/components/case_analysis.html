<!-- Case Analysis Section -->
{% if analisi_json %}
<!--begin::Content container-->
<div id="kt_app_content_container" class="app-container container-xxl animate__animated animate__fadeIn">
    <!--begin::Stats-->
    {% include "cases/components/case_analysis_stats.html" %}
    <!--end::Stats-->

    <!--begin::Card-->
    <div class="card shadow-sm hover-elevate-up">
        <!--begin::Card header-->
        <div class="card-header border-0 pt-6">
            <!--begin::Card title-->
            <div class="card-title">
                <h2 class="fw-bolder fs-2 mb-0">
                    <i class="ki-duotone ki-document-analysis fs-2 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Analisi del Caso
                </h2>
            </div>
            <!--end::Card title-->
            <!--begin::Card toolbar-->
            <div class="card-toolbar">
                <div class="d-flex justify-content-end" data-kt-user-table-toolbar="base">
                    <button type="button" class="btn btn-primary btn-lg pulse" id="regenerateBtn" data-url="{% url 'rigenera_analisi' caso.id %}">
                        <span class="pulse-ring"></span>
                        <i class="ki-duotone ki-arrows-circle fs-2 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Rigenera Analisi
                        <span class="ms-2 badge badge-light">AI</span>
                    </button>
                </div>
            </div>
            <!--end::Card toolbar-->
        </div>
        <!--end::Card header-->

        <!--begin::Card body-->
        <div class="card-body py-4">
            <div class="d-flex flex-column flex-lg-row">
                <!--begin::Tabs Navigation-->
                <div class="nav nav-tabs nav-pills border-0 flex-column align-items-start me-lg-7 mb-5 mb-lg-0" role="tablist">
                    <a class="nav-link active w-100 mb-3" data-bs-toggle="tab" href="#tab_legal" role="tab">
                        <i class="ki-duotone ki-law fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Analisi Legale
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_defense" role="tab">
                        <i class="ki-duotone ki-shield-tick fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Strategie Difensive
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_evidence" role="tab">
                        <i class="ki-duotone ki-document fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Gestione Prove
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_actions" role="tab">
                        <i class="ki-duotone ki-rocket fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Azioni Immediate
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_timeline" role="tab">
                        <i class="ki-duotone ki-calendar fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Timeline
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_risks" role="tab">
                        <i class="ki-duotone ki-warning fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Analisi Rischi
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_support" role="tab">
                        <i class="ki-duotone ki-abstract-26 fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Supporto
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_recommendations" role="tab">
                        <i class="ki-duotone ki-message-text-2 fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Raccomandazioni
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_economic" role="tab">
                        <i class="ki-duotone ki-dollar fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Aspetti Economici
                    </a>
                    <a class="nav-link w-100 mb-3" data-bs-toggle="tab" href="#tab_resolution" role="tab">
                        <i class="ki-duotone ki-flag fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>
                        Prospettive
                    </a>
                </div>
                <!--end::Tabs Navigation-->

                <!--begin::Tab Content-->
                <div class="tab-content flex-grow-1" id="analysisTabContent">
                    <!--begin::Legal Analysis-->
                    <div class="tab-pane fade show active" id="tab_legal" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_legal.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Legal Analysis-->

                    <!--begin::Defense Strategies-->
                    <div class="tab-pane fade" id="tab_defense" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_defense.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Defense Strategies-->

                    <!--begin::Evidence Management-->
                    <div class="tab-pane fade" id="tab_evidence" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_evidence.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Evidence Management-->

                    <!--begin::Immediate Actions-->
                    <div class="tab-pane fade" id="tab_actions" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_actions.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Immediate Actions-->

                    <!--begin::Timeline-->
                    <div class="tab-pane fade" id="tab_timeline" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_timeline.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Timeline-->

                    <!--begin::Risk Analysis-->
                    <div class="tab-pane fade" id="tab_risks" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_risks.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Risk Analysis-->

                    <!--begin::Support and Resources-->
                    <div class="tab-pane fade" id="tab_support" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_support.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Support and Resources-->

                    <!--begin::Recommendations-->
                    <div class="tab-pane fade" id="tab_recommendations" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_recommendations.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Recommendations-->

                    <!--begin::Economic Aspects-->
                    <div class="tab-pane fade" id="tab_economic" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_economic.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Economic Aspects-->

                    <!--begin::Resolution Prospects-->
                    <div class="tab-pane fade" id="tab_resolution" role="tabpanel">
                        <div class="card card-flush shadow-sm">
                            <div class="card-body">
                                {% include "cases/components/case_analysis_resolution.html" %}
                            </div>
                        </div>
                    </div>
                    <!--end::Resolution Prospects-->
                </div>
                <!--end::Tab Content-->
            </div>
        </div>
        <!--end::Card body-->
    </div>
    <!--end::Card-->
</div>
<!--end::Content container-->

<!-- Add custom styles -->
<style>
    /* Vertical Tab Navigation Styles */
    .nav-tabs {
        min-width: 250px;
        border-bottom: 0;
        border-right: 2px solid var(--bs-gray-200);
    }

    .nav-tabs .nav-link {
        border: none;
        color: var(--bs-gray-600);
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        border-right: 2px solid transparent;
        margin-right: -2px;
        border-radius: 0.5rem 0 0 0.5rem;
    }

    .nav-tabs .nav-link:hover {
        color: var(--bs-primary);
        background: var(--bs-light);
        border-right-color: var(--bs-primary-light);
    }

    .nav-tabs .nav-link.active {
        color: var(--bs-primary);
        background: var(--bs-light);
        border-right-color: var(--bs-primary);
    }

    /* Tab Content Styles */
    .tab-content {
        padding-left: 1.5rem;
    }

    .tab-pane {
        animation: fadeIn 0.3s ease-in-out;
    }

    .card-flush {
        box-shadow: 0 0.1rem 1rem 0.25rem rgba(0, 0, 0, 0.05);
        border-radius: 0.75rem;
        border: none;
    }

    /* Loading animation for regenerate button */
    .btn-primary.loading {
        position: relative;
        pointer-events: none;
        opacity: 0.8;
    }

    .btn-primary.loading:after {
        content: '';
        position: absolute;
        width: 1rem;
        height: 1rem;
        border: 2px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        animation: button-loading-spinner 1s ease infinite;
    }

    @keyframes button-loading-spinner {
        from {
            transform: rotate(0turn);
        }
        to {
            transform: rotate(1turn);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 991px) {
        .nav-tabs {
            min-width: 100%;
            border-right: 0;
            border-bottom: 2px solid var(--bs-gray-200);
            margin-bottom: 1.5rem;
        }

        .nav-tabs .nav-link {
            border-right: 0;
            border-bottom: 2px solid transparent;
            margin-right: 0;
            margin-bottom: -2px;
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .nav-tabs .nav-link:hover,
        .nav-tabs .nav-link.active {
            border-right-color: transparent;
            border-bottom-color: var(--bs-primary);
        }

        .tab-content {
            padding-left: 0;
        }
    }
</style>

<!-- Add custom script for loading state -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const regenerateBtn = document.getElementById('regenerateBtn');
    
    regenerateBtn.addEventListener('click', function(e) {
        // Prevent default button behavior
        e.preventDefault();
        
        // Get the URL from data attribute
        const url = this.getAttribute('data-url');
        
        // Add loading state
        this.classList.add('loading');
        const originalText = this.innerHTML;
        this.innerHTML = '<span class="spinner"></span> Rigenerando...';
        this.disabled = true;
        
        // Navigate to the regenerate URL
        window.location.href = url;
    });
});
</script>
{% endif %}
